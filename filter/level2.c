/******************************************************************************
 * FIR filter implementation in C
 *
 * compile command: gcc level2.c -o main
 *
 * ihsan kehribar - 2013
 *****************************************************************************/
#define PROFILE 1
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#if PROFILE
#include <time.h>
struct timespec start;
struct timespec end;
long int diff;
#endif

/* Filter related definitions */
#define N 254 
float xcirc[N]; 
uint16_t newest = 0;
const float B_fir[N] = {
-0.0001005471131,-9.984209464e-05,-0.0001422338391, -0.00018962592,-0.0002391130984,
  -0.0002866012219,-0.0003270824382,-0.0003544345964,-0.0003619017371,-0.0003425436444,
  -0.0002892382618,-0.0001957982313,-5.714908548e-05,0.0001299410796,0.0003663784591,
  0.0006502369652,0.0009764004499,  0.00133648573, 0.001718715881, 0.002108468674,
   0.002488520229, 0.002840012778, 0.003143222304, 0.003378901398, 0.003529325826,
   0.003579735989, 0.003519413061, 0.003342829645, 0.003050422762, 0.002649181522,
    0.00215270929, 0.001581000397,0.0009596464224,0.0003187265538,-0.0003088320664,
  -0.0008890231838,-0.001388962613,-0.001778918901,-0.002034538658,-0.002138611861,
   -0.00208274927,-0.001868280582,-0.001506836503,-0.001019999268,-0.0004384950735,
  0.0001995023631,0.0008504734724, 0.001468348783, 0.002007452073, 0.002425752115,
   0.002687886357, 0.002768039238, 0.002652136143, 0.002339505823, 0.001843497157,
   0.001191320596,0.0004227067402,-0.0004122002574,-0.001256025047, -0.00204781373,
  -0.002727352083,-0.003239456564,-0.003538329154,-0.003591273678,-0.003381854156,
  -0.002911866177,-0.002202256816,-0.001292553497,-0.0002390639565,0.0008883907576,
   0.002010753378, 0.003045059508, 0.003910200205, 0.004533011001, 0.004853975959,
   0.004832408857, 0.004450406414, 0.003715520026, 0.002661583945, 0.001347843208,
  -0.0001439608895,-0.001714141807,-0.003251323476,-0.004639765248,-0.005767556373,
   -0.00653489586,-0.006862112321,-0.006696610246,-0.006018412299, -0.00484361127,
  -0.003225582186,-0.001253523631,0.0009514986887, 0.003243104555, 0.005458227359,
   0.007427558303, 0.008986986242, 0.009989531711,  0.01031678915, 0.009889283217,
   0.008674816228, 0.006694304291, 0.004024433438,0.0007969496073,-0.002805698896,
  -0.006558129098,  -0.0102030104,  -0.0134646073, -0.01606427506, -0.01773691364,
   -0.01824751683, -0.01740672439, -0.01508445665, -0.01122067496,-0.005832592025,
  0.0009823065484, 0.009047644213,  0.01811408997,   0.0278695412,  0.03795314208,
    0.04797235876,  0.05752224475,  0.06620579213,  0.07365424186,  0.07954621315,
    0.08362452686,  0.08570976555,  0.08570976555,  0.08362452686,  0.07954621315,
    0.07365424186,  0.06620579213,  0.05752224475,  0.04797235876,  0.03795314208,
     0.0278695412,  0.01811408997, 0.009047644213,0.0009823065484,-0.005832592025,
   -0.01122067496, -0.01508445665, -0.01740672439, -0.01824751683, -0.01773691364,
   -0.01606427506,  -0.0134646073,  -0.0102030104,-0.006558129098,-0.002805698896,
  0.0007969496073, 0.004024433438, 0.006694304291, 0.008674816228, 0.009889283217,
    0.01031678915, 0.009989531711, 0.008986986242, 0.007427558303, 0.005458227359,
   0.003243104555,0.0009514986887,-0.001253523631,-0.003225582186, -0.00484361127,
  -0.006018412299,-0.006696610246,-0.006862112321, -0.00653489586,-0.005767556373,
  -0.004639765248,-0.003251323476,-0.001714141807,-0.0001439608895, 0.001347843208,
   0.002661583945, 0.003715520026, 0.004450406414, 0.004832408857, 0.004853975959,
   0.004533011001, 0.003910200205, 0.003045059508, 0.002010753378,0.0008883907576,
  -0.0002390639565,-0.001292553497,-0.002202256816,-0.002911866177,-0.003381854156,
  -0.003591273678,-0.003538329154,-0.003239456564,-0.002727352083, -0.00204781373,
  -0.001256025047,-0.0004122002574,0.0004227067402, 0.001191320596, 0.001843497157,
   0.002339505823, 0.002652136143, 0.002768039238, 0.002687886357, 0.002425752115,
   0.002007452073, 0.001468348783,0.0008504734724,0.0001995023631,-0.0004384950735,
  -0.001019999268,-0.001506836503,-0.001868280582, -0.00208274927,-0.002138611861,
  -0.002034538658,-0.001778918901,-0.001388962613,-0.0008890231838,-0.0003088320664,
  0.0003187265538,0.0009596464224, 0.001581000397,  0.00215270929, 0.002649181522,
   0.003050422762, 0.003342829645, 0.003519413061, 0.003579735989, 0.003529325826,
   0.003378901398, 0.003143222304, 0.002840012778, 0.002488520229, 0.002108468674,
   0.001718715881,  0.00133648573,0.0009764004499,0.0006502369652,0.0003663784591,
  0.0001299410796,-5.714908548e-05,-0.0001957982313,-0.0002892382618,-0.0003425436444,
  -0.0003619017371,-0.0003544345964,-0.0003270824382,-0.0002866012219,-0.0002391130984,
   -0.00018962592,-0.0001422338391,-9.984209464e-05,-0.0001005471131
};


void initFir()
{
	uint16_t q;
	
	/* Initialize all the samples with zero */
	for(q=0;q<N;q++)
	{
		xcirc[q] = 0.0f;
	}
}

float updateFir(float newSample)
{
	uint16_t k;
	float temp1;
	float temp2;
	int32_t x_index;
	float mul_result;
	float accumulator = 0.0f;
	
	/* Circularly increment newest index */
	++newest;

	/* Fold if neccessary ... */
	if(newest == N)
	{
		newest = 0;
	}

	/* Put new sample in delay line */
	xcirc[newest] = newSample;

	/* Do convolution sum */
	x_index = newest;
	for(k = 0; k < N; k++)
	{
		/* Do the math ... */
		temp1 = B_fir[k];
		temp2 = xcirc[x_index];
		mul_result = temp1 * temp2;
		accumulator += mul_result;	
	
		/* Circularly decrement x_index */
		--x_index;

		/* Fold if neccessary */
		if(x_index == -1)
		{
			x_index = N-1;
		}
	}

	/* Return the filter result ... */
	return accumulator;
}	

int main()
{
	int r;
	FILE *raw;
	FILE *filtered;
	float temp_input;
	float temp_output;
	int lineNumber = 0;
	char inputBuffer[512];

	initFir();
	printf("Hi there!\n");

	raw = fopen("raw.txt","r");
	if(raw == NULL)
	{
		printf("Couldn't open the input file!\n");
		return -1;
	}

	filtered = fopen("output.txt","w");
	if(filtered == NULL)
	{
		printf("Couldn't create the output file!\n");
		return -1;
	}

	while(1)
	{
		if(fgets(inputBuffer,sizeof(inputBuffer),raw) != NULL)
		{
			sscanf(inputBuffer,"%f\n",&temp_input);
			#if PROFILE
			clock_gettime(CLOCK_REALTIME,&start);
			#endif
			temp_output = updateFir(temp_input);
			#if PROFILE
			clock_gettime(CLOCK_REALTIME,&end);
			diff = end.tv_nsec - start.tv_nsec;
			printf("Time: %d ns\n",diff);
			#endif
			fprintf(filtered,"%f\n",temp_output);
			printf("#l:%d #i:%f #o:%f\n",lineNumber++,temp_input,temp_output);
		}
		else
		{
			break;
		}
	}

	return 0;
}
